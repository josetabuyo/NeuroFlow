---
description: Procedure for adding a new mask/wiring preset to NeuroFlow
globs: backend/core/masks.py
alwaysApply: false
---

# Adding a new mask preset

When the user requests a new wiring/mask, follow these steps in order:

## 0. Interpret the user's notation

The user can request a mask in two ways:

**Explicit form:** `E2 G6 I3 DE1 DI1`

**Numeric shorthand:** `2 6 3 1 1`

The default order is always: **E G I DE DI**

| Position | Parameter | Meaning | How it translates to code |
|----------|-----------|---------|--------------------------|
| 1st | **E** | Excitatory Moore radius | `_moore(E)` |
| 2nd | **G** | Gap (silence rings) | gap goes from r=E+1 to r=E+G |
| 3rd | **I** | Inhibitory rings | `_ring(E+G+1, E+G+I)` |
| 4th | **DE** | Excitatory density (1/DE) | DE=1 → full, DE=3 → `_random_sparse(..., 1/3, seed)` |
| 5th | **DI** | Inhibitory density (1/DI) | DI=1 → full, DI=1.5 → `_random_sparse(..., 2/3, seed)` |

If the user omits DE and DI, assume DE=1 DI=1 (full density).

**Example:** `2 6 3 1 1` → E=2, G=6, I=3, DE=1, DI=1
- Excitation: `_moore(2)` (24 neighbors, full)
- Gap: r=3 to r=8 (6 silence rings)
- Inhibition: `_ring(9, 11)` (3 rings, full)

**Example with density:** `3 12 3 3 3` → E=3, G=12, I=3, DE=3, DI=3
- Excitation: `_random_sparse(_moore(3), 1/3, seed=42)`
- Inhibition: `_make_inhibitory(_random_sparse(_ring(16, 18), 1/3, seed=43), -1.0, 8)`

## 1. Define the mask in `backend/core/masks.py`

- Add the constant `MASK_DEAMON_E<n>_G<n>_I<n>_DE<n>_DI<n>: MaskDef = [...]` alongside the others.
- Use existing helpers: `_moore()`, `_ring()`, `_von_neumann()`, `_sparse_ring()`, `_random_sparse()`, `_make_inhibitory()`, `_partition()`.
- Follow convention: excitatory dendrites first (weight > 0), then inhibitory (weight < 0).
- For density: DE=1/DI=1 → don't use `_random_sparse`. For other values → `_random_sparse(offsets, 1/D, seed=N)`.
- Use incremental seeds (42+ for exc, 43+ for inh) so each mask has its own pattern.

## 2. Register in `MASK_PRESETS`

Add the entry in the `MASK_PRESETS` dict in the same file with all fields:

```python
"deamon_e2_g6_i3_de1_di1": {
    "id": "deamon_e2_g6_i3_de1_di1",
    "name": "Deamon (E2 G6 I3 DE1 DI1)",
    "description": "Moore r=2 full (24 neighbors), gap r=3-8, corona r=9-11 full.",
    "center": "Moore r=2 (24 neighbors, full density)",
    "corona": "r=9-11 full, gap r=3-8 silence (x6)",
    "dendrites_inh": 8,
    "random_weights": True,
    "mask": MASK_DEAMON_E2_G6_I3_DE1_DI1,
},
```

## 3. Update test count

In `backend/tests/test_deamons_lab.py`, find `assert len(info) == N` inside `test_get_mask_info_excludes_mask_data` and increment N by 1 for each new mask.

## 4. Run tests

```bash
cd /Users/josetabuyo/Personal/NeuroFlow && ./venv/bin/python -m pytest backend/tests/ -x -q
```

Verify 0 failures before continuing.

## 5. Verify the web

- Use `browser_tabs` with action `list` to see if there's already an open tab with the app (localhost:5173).
- If there's an open tab: `browser_navigate` to the current URL to reload and pick up backend changes (auto-reload with uvicorn) and frontend (Vite HMR).
- If no tab: open `http://localhost:5173` with `browser_navigate`.
- Take a `browser_snapshot` and verify the new mask appears in the wiring dropdown.

## 6. Quick validation

- Confirm the new mask name appears in the list.
- Confirm the preview grid renders correctly for the new mask.

## Important notes

- The source of truth for `default_config` is `backend/api/routes.py` (the API overrides frontend defaults on load).
- The preview grid is dynamic: it adapts to the wiring size automatically.
- The backend has `--reload`, changes to `.py` files are picked up automatically. The frontend with Vite HMR likewise.
- DO NOT touch `frontend/src/App.tsx` to add masks: masks are loaded dynamically from the API via `get_mask_info()`.
